@using Shared.Helpers
@using System.Reflection
@using Frontend.Records
@using Frontend.Models.Interfaces
@using Shared.Models.Interfaces
@implements IItemListablePageModel<string>
@inject NavigationManager Navigation

@if (ViewModel is not null)
{
    <h3>Insumos</h3>

    <div class="filtro-container">
        <div class="filtro-campos">

            <InputSelect class="form-select filtro-select" @bind-Value="ViewModel.ChavePesquisa">
                <option value="">Filtrar por...</option>
                @foreach (var filtro in ViewModel.Filtro.GetType().GetProperties())
                {
                    <option value="@filtro.Name">@DisplayNameHelper.DisplayNameFor(filtro)</option>
                }
            </InputSelect>

            <InputText class="form-control filtro-input"
                       placeholder="Digite o valor..."
                       @bind-Value="ViewModel.ValorPesquisa" />

        </div>

        <button class="btn btn-primary filtro-botao"
                @onclick='() => ViewModel.FiltrarInsumosCommand.ExecuteAsync(new PesquisaProduto(ViewModel.ChavePesquisa, ViewModel.ValorPesquisa))'>
            <i class="bi bi-search"></i> Filtrar
        </button>
    </div>

    <div class="caixaBranca">
        @if (ViewModel.Carregando)
        {
            <SpinnerComponent />
        }
        else
        {
            <div class="row g-3">
                @foreach (var i in ViewModel.Insumos)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm">

                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div class="tituloCard">
                                    <h5 class="mb-1">@i.NomeItem</h5>
                                    <small>@DisplayNameHelper.DisplayNameFor(() => i.CodItem): @i.CodItem</small>
                                </div>

                                <button class="btn btn-light btn-sm" @onclick="@(() => Toggle(i.CodItem))">
                                    @(ItensAbertos.ContainsKey(i.CodItem) && ItensAbertos[i.CodItem] ? "Fechar" : "Ver mais")
                                </button>
                            </div>

                            <div class="card-body">

                                <div class="d-flex justify-content-between mb-3">
                                    <div class="info-principal">
                                        <label class="fw-bold me-1">
                                            <i class="bi bi-calendar-event"></i> Data Última Entrega:
                                        </label>
                                        <span>@InsumosViewModel.DisplayDataEntregaRecente(i)</span>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mb-3">
                                    <div class="info-principal">
                                        <label class="fw-bold me-1">
                                            <i class="bi bi-box-seam"></i> Quantidade em Estoque:
                                        </label>
                                        <span>@i.ItensEstoque.Sum(x => x.Quantidade)</span>
                                    </div>
                                </div>

                                @if (ItensAbertos.ContainsKey(i.CodItem) && ItensAbertos[i.CodItem])
                                {
                                    <div class="maisInfo mt-2">
                                        <div class="row">

                                            <div class="col-12 mb-2">
                                                <label class="fw-bold">
                                                    <i class="bi bi-card-text"></i>
                                                    @DisplayNameHelper.DisplayNameFor(() => i.DescricaoDetalhada):
                                                </label>
                                                <div>@InsumosViewModel.DisplayDescricaoDetalhada(i)</div>
                                            </div>

                                            <div class="col-6 mb-2">
                                                <label class="fw-bold">
                                                    <i class="bi bi-box-seam"></i>
                                                    @DisplayNameHelper.DisplayNameFor(() => i.Unidade):
                                                </label>
                                                <span class="badge bg-success">@i.Unidade</span>
                                            </div>

                                            <div class="col-6 mb-2">
                                                <label class="fw-bold">
                                                    <i class="bi bi-clock"></i> Data Última Validade:
                                                </label>
                                                <div class="@(
                                                     ((DateTime.TryParse(InsumosViewModel.DisplayDataValidadeRecente(i), out DateTime r) ? r : DateTime.Today)
                                                      < DateTime.Today)
                                                      ? "text-danger fw-bold" : ""
                                                                                                                                                                                                )">
                                                @InsumosViewModel.DisplayDataValidadeRecente(i)
                                            </div>
                                        </div>

                                        </div>
                                    </div>
                                        }

                                <div class="mt-4 d-flex justify-content-end gap-2">
                                    <button class="btn btn-outline-danger btn-sm"
                                            @onclick="() => ViewModel.DeletarInsumoCommand.ExecuteAsync(i)">
                                        <i class="bi bi-trash"></i> Deletar
                                    </button>

                                    <button class="btn btn-outline-primary btn-sm"
                                            @onclick="() => VerDetalhes(i.IdItem)">
                                        <i class="bi bi-info-circle"></i> Detalhes
                                    </button>
                                </div>

                            </div>

                        </div>
                    </div>
                }
            </div>

            @* ════════════════════════════════════════════════════════════ *@
            @* ← BOTÃO DE SINCRONIZAÇÃO CORRIGIDO *@
            @* ════════════════════════════════════════════════════════════ *@
            <div class="sync-container mt-4">
                <button class="btn btn-success sync-button"
                        @onclick="SincronizarAsync"
                        disabled="@ViewModel.Sincronizando">
                    @if (ViewModel.Sincronizando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Sincronizando com AWS...</span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-upload"></i>
                        <span>Sincronizar na nuvem</span>
                    }
                </button>

                @* Indicador de status da sincronização *@
                @if (!string.IsNullOrEmpty(_statusSync))
                {
                    <div class="alert @(_statusSyncSucesso ? "alert-success" : "alert-danger") mt-2 fade-in" role="alert">
                        <i class="bi @(_statusSyncSucesso ? "bi-check-circle" : "bi-exclamation-triangle")"></i>
                        @_statusSync
                    </div>
                }
            </div>
        }
    </div>

    <div class="mt-4 action-buttons">
        <button class="btn btn-primary mb-3"
                @onclick="ViewModel.CarregarInsumosCommand.ExecuteAsync"
                disabled="@ViewModel.Carregando">
            <i class="bi bi-arrow-clockwise"></i> Atualizar Dados
        </button>

        <button class="btn btn-primary mb-3"
                @onclick="(() => ViewModel.AbreAbaCadastro())">
            <i class="bi bi-plus-circle"></i> Cadastrar Novo Insumo
        </button>
    </div>
}

@code {
    [Parameter]
    public InsumosViewModel ViewModel { get; set; } = default!;

    public Dictionary<string, bool> ItensAbertos { get; set; } = new();

    private string _statusSync = string.Empty;
    private bool _statusSyncSucesso = false;

    void Toggle(string codigo)
    {
        if (ItensAbertos.TryGetValue(codigo, out bool value))
            ItensAbertos[codigo] = !value;
        else
            ItensAbertos[codigo] = true;
    }

    void VerDetalhes(int idInsumo, string tipo = "insumos")
    {
        Navigation.NavigateTo($"/estoque/detalhes/{tipo}/{idInsumo}");
    }

    // ════════════════════════════════════════════════════════════
    // ← MÉTODO DE SINCRONIZAÇÃO COM AWS
    // ════════════════════════════════════════════════════════════
    private async Task SincronizarAsync()
    {
        try
        {
            _statusSync = string.Empty;
            _statusSyncSucesso = false;
            StateHasChanged();

            System.Diagnostics.Debug.WriteLine("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
            System.Diagnostics.Debug.WriteLine("[InsumosListarTab] 🚀 Botão de sincronização clicado");
            System.Diagnostics.Debug.WriteLine("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");

            // Executar o comando de sincronização da ViewModel
            await ViewModel.SincronizarInsumosCommand.ExecuteAsync(null);

            _statusSync = "✅ Sincronização concluída com sucesso!";
            _statusSyncSucesso = true;

            System.Diagnostics.Debug.WriteLine("[InsumosListarTab] ✅ Sincronização concluída");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[InsumosListarTab] ❌ Erro na sincronização: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"[InsumosListarTab] StackTrace: {ex.StackTrace}");

            _statusSync = $"❌ Erro ao sincronizar: {ex.Message}";
            _statusSyncSucesso = false;
        }
        finally
        {
            StateHasChanged();

            // Limpar mensagem após 5 segundos
            await Task.Delay(5000);
            _statusSync = string.Empty;
            StateHasChanged();
        }
    }
}

<style>
    /* ════════════════════════════════════════════════════════════ */
    /* ESTILOS DO BOTÃO DE SINCRONIZAÇÃO */
    /* ════════════════════════════════════════════════════════════ */
    .sync-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .sync-button {
        min-width: 250px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

        .sync-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .sync-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .sync-button i {
            margin-right: 0.5rem;
        }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

        .action-buttons .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
</style>
